<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Problem Code</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/monokai.min.css">
    <style>
        :root {
            --bg-deep-space: #0a0a0f;
            --bg-cosmic: #151520;
            --bg-stellar: #1e1e2d;
            --bg-nebula: #252536;
            --neon-purple: #8b5cf6;
            --neon-violet: #a855f7;
            --neon-fuchsia: #d946ef;
            --neon-cyan: #06b6d4;
            --gradient-primary: linear-gradient(135deg, #8b5cf6, #d946ef);
            --text-stellar: #ffffff;
            --text-milky: #e2e8f0;
            --text-dust: #94a3b8;
            --success-emerald: #10b981;
            --warning-amber: #f59e0b;
            --error-crimson: #ef4444;
            --info-sapphire: #3b82f6;
            --glow-primary: 0 0 20px rgba(139, 92, 246, 0.5);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--bg-deep-space);
            color: var(--text-milky);
            overflow: hidden;
        }

        .language-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(10, 10, 15, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .modal-header h2 {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .language-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 2rem;
            max-width: 800px;
            width: 100%;
        }

        .language-card {
            background: transparent;
            border-radius: 12px;
            padding: 2rem 1rem;
            text-align: center;
            cursor: pointer;
            border: 2px solid var(--neon-purple);
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .language-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--glow-primary);
            background: rgba(139, 92, 246, 0.1);
        }

        .language-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            color: var(--neon-purple);
        }

        .language-name {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .main-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .app-header {
            background-color: var(--bg-cosmic);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--bg-nebula);
        }

        .logo {
            font-size: 1.8rem;
            font-weight: 700;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .language-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--bg-stellar);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            border: 1px solid var(--neon-purple);
        }

        .btn-check-code {
            background: var(--gradient-primary);
            color: white;
            border: none;
            padding: 0.5rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
            box-shadow: var(--glow-primary);
        }

        .btn-check-code:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 25px rgba(139, 92, 246, 0.6);
        }

        .btn-check-code:active {
            transform: translateY(0);
        }

        .btn-check-code.analyzing {
            animation: pulse 1.5s infinite;
        }

        .btn-change-language {
            background: var(--bg-stellar);
            border: 1px solid var(--neon-purple);
            color: var(--text-milky);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-change-language:hover {
            background: var(--neon-purple);
        }

        .editor-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .code-editor-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: var(--bg-stellar);
        }

        .editor-header {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            padding: 1rem;
            background-color: var(--bg-cosmic);
            border-bottom: 1px solid var(--bg-nebula);
        }

        #code-editor {
            flex: 1;
            overflow: hidden;
        }

        .CodeMirror {
            height: 100%;
            font-size: 14px;
            line-height: 1.5;
        }

        .error-panel {
            width: 400px;
            background-color: var(--bg-cosmic);
            border-left: 1px solid var(--bg-nebula);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .panel-header {
            padding: 1rem;
            background-color: var(--bg-stellar);
            border-bottom: 1px solid var(--bg-nebula);
        }

        .panel-header h3 {
            margin-bottom: 0.5rem;
        }

        .error-stats {
            display: flex;
            gap: 1rem;
            font-size: 0.9rem;
        }

        .error-count {
            color: var(--error-crimson);
        }

        .warning-count {
            color: var(--warning-amber);
        }

        .suggestion-count {
            color: var(--info-sapphire);
        }

        .error-list {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        .error-item {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-radius: 6px;
            background-color: var(--bg-stellar);
            border-left: 4px solid var(--error-crimson);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .error-item:hover {
            transform: translateX(5px);
        }

        .error-item.warning {
            border-left-color: var(--warning-amber);
        }

        .error-item.suggestion {
            border-left-color: var(--info-sapphire);
        }

        .error-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.25rem;
        }

        .error-icon {
            font-size: 1.2rem;
        }

        .error-title {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .error-description {
            font-size: 0.85rem;
            color: var(--text-dust);
            margin-bottom: 0.25rem;
        }

        .error-location {
            font-size: 0.8rem;
            color: var(--text-dust);
        }

        .execution-result {
            background: var(--bg-nebula);
            padding: 1rem;
            margin: 0.5rem 0;
            border-radius: 6px;
            border-left: 4px solid var(--neon-cyan);
        }

        .execution-result h4 {
            color: var(--neon-cyan);
            margin-bottom: 0.5rem;
        }

        .output-console {
            background: var(--bg-deep-space);
            padding: 0.75rem;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .analysis-progress {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.5rem 1rem;
            background: var(--bg-stellar);
            border-radius: 8px;
        }

        .progress-bar {
            width: 100px;
            height: 4px;
            background: var(--bg-nebula);
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--gradient-primary);
            transition: width 0.3s ease;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(139, 92, 246, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(139, 92, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(139, 92, 246, 0); }
        }

        .error-marker {
            background-color: rgba(239, 68, 68, 0.1);
            border-bottom: 2px wavy var(--error-crimson);
        }

        .warning-marker {
            background-color: rgba(245, 158, 11, 0.1);
            border-bottom: 2px wavy var(--warning-amber);
        }

        .suggestion-marker {
            background-color: rgba(59, 130, 246, 0.1);
            border-bottom: 2px wavy var(--info-sapphire);
        }

        @media (max-width: 1024px) {
            .language-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .error-panel {
                width: 300px;
            }
        }

        @media (max-width: 768px) {
            .editor-container {
                flex-direction: column;
            }
            .error-panel {
                width: 100%;
                height: 300px;
            }
            .language-grid {
                grid-template-columns: 1fr;
            }
            .header-controls {
                gap: 0.5rem;
            }
            .btn-check-code span:last-child {
                display: none;
            }
            .btn-check-code {
                padding: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="language-modal" id="language-modal">
        <div class="modal-header">
            <h2>Problem Code</h2>
            <p>–í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã</p>
        </div>
        <div class="language-grid">
            <div class="language-card" data-lang="javascript">
                <div class="language-icon">JS</div>
                <div class="language-name">JavaScript</div>
            </div>
            <div class="language-card" data-lang="python">
                <div class="language-icon">Py</div>
                <div class="language-name">Python</div>
            </div>
            <div class="language-card" data-lang="html">
                <div class="language-icon">H5</div>
                <div class="language-name">HTML</div>
            </div>
        </div>
    </div>

    <div class="main-container" id="main-container">
        <header class="app-header">
            <div class="logo">Problem Code</div>
            <div class="header-controls">
                <div class="language-indicator">
                    <span class="current-language" id="current-language">JavaScript</span>
                </div>
                <button class="btn-check-code" id="check-code">
                    <span>üîç</span>
                    <span>–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–¥</span>
                </button>
                <button class="btn-change-language" id="change-language">–°–º–µ–Ω–∏—Ç—å —è–∑—ã–∫</button>
            </div>
        </header>
        
        <main class="editor-container">
            <div class="code-editor-wrapper">
                <div class="editor-header">
                    <div class="analysis-progress" id="analysis-progress" style="display: none;">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                        </div>
                        <span>–ö–æ–º–ø–∏–ª—è—Ü–∏—è –∏ –∞–Ω–∞–ª–∏–∑...</span>
                    </div>
                </div>
                <div id="code-editor"></div>
            </div>
            
            <div class="error-panel">
                <div class="panel-header">
                    <h3>–ê–Ω–∞–ª–∏–∑ –∫–æ–¥–∞</h3>
                    <div class="error-stats">
                        <span class="error-count" id="error-count">0 –æ—à–∏–±–æ–∫</span>
                        <span class="warning-count" id="warning-count">0 –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π</span>
                        <span class="suggestion-count" id="suggestion-count">0 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π</span>
                    </div>
                </div>
                <div class="error-list" id="error-list"></div>
            </div>
        </main>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/python/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/matchbrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/closebrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/esprima/4.0.1/esprima.min.js"></script>
    <script>
        class RealCodeAnalyzer {
            constructor() {
                this.languages = {
                    javascript: {
                        id: 'javascript',
                        name: 'JavaScript',
                        syntax: 'javascript',
                        template: ``
                    },
                    python: {
                        id: 'python',
                        name: 'Python',
                        syntax: 'python',
                        template: ``
                    },
                    html: {
                        id: 'html',
                        name: 'HTML',
                        syntax: 'html',
                        template: ``
                    }
                };
                
                this.currentLanguage = null;
                this.editor = null;
                this.errorMarkers = [];
            }

            initializeApp() {
                this.initializeLanguageSelector();
                this.showLanguageModal();
            }

            initializeLanguageSelector() {
                const languageCards = document.querySelectorAll('.language-card');
                languageCards.forEach(card => {
                    card.addEventListener('click', () => {
                        const lang = card.getAttribute('data-lang');
                        this.selectLanguage(lang);
                    });
                });

                document.getElementById('change-language').addEventListener('click', () => {
                    this.showLanguageModal();
                });

                document.getElementById('check-code').addEventListener('click', () => {
                    this.analyzeCode();
                });
            }

            showLanguageModal() {
                document.getElementById('language-modal').style.display = 'flex';
                document.getElementById('main-container').style.opacity = '0';
            }

            selectLanguage(lang) {
                this.currentLanguage = this.languages[lang];
                document.getElementById('current-language').textContent = this.currentLanguage.name;
                document.getElementById('language-modal').style.display = 'none';
                document.getElementById('main-container').style.opacity = '1';
                
                this.initializeEditor();
            }

            initializeEditor() {
                const editorElement = document.getElementById('code-editor');
                
                if (this.editor) {
                    this.editor.toTextArea();
                }
                
                this.editor = CodeMirror(editorElement, {
                    value: this.currentLanguage.template,
                    mode: this.currentLanguage.syntax,
                    lineNumbers: true,
                    matchBrackets: true,
                    autoCloseBrackets: true,
                    indentUnit: 4,
                    theme: 'monokai',
                    lineWrapping: true
                });
                
                this.clearErrorMarkers();
                this.resetErrorPanel();
            }

            async analyzeCode() {
                if (!this.editor || !this.currentLanguage) return;

                const code = this.editor.getValue();
                
                const progress = document.getElementById('analysis-progress');
                const progressFill = document.getElementById('progress-fill');
                const checkButton = document.getElementById('check-code');
                
                progress.style.display = 'flex';
                checkButton.classList.add('analyzing');

                for (let i = 0; i <= 100; i += 20) {
                    progressFill.style.width = i + '%';
                    await new Promise(resolve => setTimeout(resolve, 100));
                }

                try {
                    const results = await this.performRealAnalysis(code, this.currentLanguage);
                    this.displayAnalysisResults(results, code);
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞:', error);
                    this.displayError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –∫–æ–¥–∞: ' + error.message);
                } finally {
                    setTimeout(() => {
                        progress.style.display = 'none';
                        checkButton.classList.remove('analyzing');
                        progressFill.style.width = '0%';
                    }, 300);
                }
            }

            async performRealAnalysis(code, language) {
                const results = {
                    errors: [],
                    warnings: [],
                    suggestions: [],
                    executionResult: null,
                    score: 100
                };

                if (!code.trim()) {
                    results.errors.push({
                        type: 'SYNTAX_ERROR',
                        message: '–ö–æ–¥ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º',
                        line: 1,
                        column: 1
                    });
                    return results;
                }

                switch (language.id) {
                    case 'javascript':
                        await this.analyzeJavaScript(code, results);
                        break;
                    case 'python':
                        await this.analyzePython(code, results);
                        break;
                    case 'html':
                        await this.analyzeHTML(code, results);
                        break;
                }

                results.score = this.calculateScore(results);
                return results;
            }

            async analyzeJavaScript(code, results) {
                try {
                    const syntaxErrors = this.checkJavaScriptSyntax(code);
                    results.errors.push(...syntaxErrors);

                    if (syntaxErrors.length === 0) {
                        const executionResult = await this.executeJavaScript(code);
                        results.executionResult = executionResult;
                        
                        const additionalChecks = this.checkJavaScriptPatterns(code);
                        results.warnings.push(...additionalChecks.warnings);
                        results.suggestions.push(...additionalChecks.suggestions);
                    }
                } catch (error) {
                    results.errors.push({
                        type: 'RUNTIME_ERROR',
                        message: `–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: ${error.message}`,
                        line: this.extractLineFromError(error, code),
                        column: 1
                    });
                }
            }

            checkJavaScriptSyntax(code) {
                const errors = [];
                try {
                    esprima.parseScript(code, { 
                        tolerant: false,
                        loc: true,
                        range: true
                    });
                    
                } catch (error) {
                    const lineMatch = error.message.match(/Line (\d+)/);
                    const columnMatch = error.message.match(/Column (\d+)/);
                    const description = error.message.split('\n')[0];
                    
                    errors.push({
                        type: 'SYNTAX_ERROR',
                        message: `–°–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: ${description}`,
                        line: lineMatch ? parseInt(lineMatch[1]) : 1,
                        column: columnMatch ? parseInt(columnMatch[1]) : 1
                    });
                }
                return errors;
            }

            async executeJavaScript(code) {
                return new Promise((resolve) => {
                    try {
                        const originalConsoleLog = console.log;
                        const logs = [];
                        
                        console.log = (...args) => {
                            logs.push(args.map(arg => 
                                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
                            ).join(' '));
                        };

                        const executionTimeout = setTimeout(() => {
                            throw new Error('–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (5 —Å–µ–∫—É–Ω–¥)');
                        }, 5000);

                        try {
                            const result = Function(`
                                "use strict";
                                ${code}
                            `)();
                            
                            clearTimeout(executionTimeout);
                            console.log = originalConsoleLog;
                            
                            resolve({
                                output: logs.join('\n'),
                                returnValue: result,
                                success: true
                            });
                            
                        } catch (error) {
                            clearTimeout(executionTimeout);
                            console.log = originalConsoleLog;
                            throw error;
                        }
                        
                    } catch (error) {
                        resolve({
                            output: '',
                            error: error.message,
                            success: false
                        });
                    }
                });
            }

            checkJavaScriptPatterns(code) {
                const warnings = [];
                const suggestions = [];
                
                try {
                    const ast = esprima.parseScript(code, { tolerant: true, loc: true });
                    
                    const declaredVars = new Set();
                    const usedVars = new Set();
                    
                    const traverse = (node) => {
                        if (!node) return;
                        
                        if (node.type === 'VariableDeclarator' && node.id) {
                            declaredVars.add(node.id.name);
                        }
                        if (node.type === 'FunctionDeclaration' && node.id) {
                            declaredVars.add(node.id.name);
                        }
                        
                        if (node.type === 'Identifier') {
                            usedVars.add(node.name);
                        }
                        
                        for (const key in node) {
                            if (node[key] && typeof node[key] === 'object') {
                                if (Array.isArray(node[key])) {
                                    node[key].forEach(traverse);
                                } else {
                                    traverse(node[key]);
                                }
                            }
                        }
                    };
                    
                    traverse(ast);
                    
                    declaredVars.forEach(varName => {
                        if (!usedVars.has(varName) && varName !== 'console') {
                            warnings.push({
                                type: 'UNUSED_VARIABLE',
                                message: `–ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è: ${varName}`,
                                line: 1,
                                column: 1
                            });
                        }
                    });

                    if (code.includes('console.log')) {
                        warnings.push({
                            type: 'DEBUG_CODE',
                            message: '–û–±–Ω–∞—Ä—É–∂–µ–Ω console.log - —É–±–µ—Ä–∏—Ç–µ –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞',
                            line: 1,
                            column: 1
                        });
                    }

                    if (code.includes(' == ')) {
                        suggestions.push({
                            type: 'CODE_STYLE',
                            message: '–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ === –≤–º–µ—Å—Ç–æ == –¥–ª—è —Å—Ç—Ä–æ–≥–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è',
                            line: 1,
                            column: 1
                        });
                    }

                } catch (error) {
                }
                
                return { warnings, suggestions };
            }

            async analyzePython(code, results) {
                try {
                    const pythonErrors = this.checkPythonSyntax(code);
                    results.errors.push(...pythonErrors.errors);
                    results.warnings.push(...pythonErrors.warnings);
                    
                    if (pythonErrors.errors.length === 0) {
                        results.executionResult = {
                            output: "Python –∫–æ–¥ –ø—Ä–æ—à–µ–ª –±–∞–∑–æ–≤—É—é –ø—Ä–æ–≤–µ—Ä–∫—É —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞",
                            success: true
                        };
                    }
                } catch (error) {
                    results.errors.push({
                        type: 'ANALYSIS_ERROR',
                        message: `–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ Python: ${error.message}`,
                        line: 1,
                        column: 1
                    });
                }
            }

            checkPythonSyntax(code) {
                const errors = [];
                const warnings = [];
                
                const lines = code.split('\n');
                
                lines.forEach((line, index) => {
                    const lineNumber = index + 1;
                    const trimmedLine = line.trim();
                    
                    if (trimmedLine.length === 0) return;
                    
                    if (line.includes(' ') && line.includes('\t')) {
                        warnings.push({
                            type: 'INDENTATION_ERROR',
                            message: '–°–º–µ—à–∞–Ω–Ω—ã–µ –æ—Ç—Å—Ç—É–ø—ã (–ø—Ä–æ–±–µ–ª—ã –∏ —Ç–∞–±—É–ª—è—Ü–∏—è)',
                            line: lineNumber,
                            column: 1
                        });
                    }
                    
                    if (trimmedLine.endsWith(':')) {
                        const nextLineIndex = index + 1;
                        if (nextLineIndex < lines.length) {
                            const nextLine = lines[nextLineIndex];
                            if (nextLine.trim() && !nextLine.startsWith(' ') && !nextLine.startsWith('\t')) {
                                errors.push({
                                    type: 'INDENTATION_ERROR',
                                    message: '–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –æ—Ç—Å—Ç—É–ø –ø–æ—Å–ª–µ –¥–≤–æ–µ—Ç–æ—á–∏—è',
                                    line: nextLineIndex + 1,
                                    column: 1
                                });
                            }
                        }
                    }
                });
                
                const bracketStack = [];
                const brackets = { '(': ')', '[': ']', '{': '}' };
                
                for (let i = 0; i < code.length; i++) {
                    const char = code[i];
                    if (brackets[char]) {
                        bracketStack.push({ char, index: i });
                    } else if (Object.values(brackets).includes(char)) {
                        if (bracketStack.length === 0) {
                            const line = this.getLineNumber(code, i);
                            const column = this.getColumnNumber(code, i);
                            errors.push({
                                type: 'SYNTAX_ERROR',
                                message: `–õ–∏—à–Ω—è—è –∑–∞–∫—Ä—ã–≤–∞—é—â–∞—è —Å–∫–æ–±–∫–∞: ${char}`,
                                line: line,
                                column: column
                            });
                        } else {
                            const lastBracket = bracketStack[bracketStack.length - 1];
                            if (brackets[lastBracket.char] === char) {
                                bracketStack.pop();
                            } else {
                                const line = this.getLineNumber(code, i);
                                const column = this.getColumnNumber(code, i);
                                errors.push({
                                    type: 'SYNTAX_ERROR',
                                    message: `–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å–∫–æ–±–æ–∫: –æ–∂–∏–¥–∞–ª–∞—Å—å ${brackets[lastBracket.char]}, –ø–æ–ª—É—á–µ–Ω–∞ ${char}`,
                                    line: line,
                                    column: column
                                });
                            }
                        }
                    }
                }
                
                bracketStack.forEach(({ char, index }) => {
                    const line = this.getLineNumber(code, index);
                    const column = this.getColumnNumber(code, index);
                    errors.push({
                        type: 'SYNTAX_ERROR',
                        message: `–ù–µ–∑–∞–∫—Ä—ã—Ç–∞—è —Å–∫–æ–±–∫–∞: ${char}`,
                        line: line,
                        column: column
                    });
                });
                
                lines.forEach((line, index) => {
                    const lineNumber = index + 1;
                    
                    if (line.includes('print ') && !line.includes('print(')) {
                        warnings.push({
                            type: 'PYTHON_VERSION',
                            message: '–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ print() –∫–∞–∫ —Ñ—É–Ω–∫—Ü–∏—é (Python 3)',
                            line: lineNumber,
                            column: line.indexOf('print') + 1
                        });
                    }
                    
                    if (line.includes('xrange(')) {
                        warnings.push({
                            type: 'DEPRECATED',
                            message: 'xrange —É—Å—Ç–∞—Ä–µ–ª, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ range',
                            line: lineNumber,
                            column: line.indexOf('xrange') + 1
                        });
                    }
                });
                
                return { errors, warnings };
            }

            async analyzeHTML(code, results) {
                try {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(code, 'text/html');
                    
                    const parserErrors = doc.querySelectorAll('parsererror');
                    if (parserErrors.length > 0) {
                        parserErrors.forEach(error => {
                            const errorText = error.textContent;
                            const lineMatch = errorText.match(/line (\d+)/i);
                            const line = lineMatch ? parseInt(lineMatch[1]) : 1;
                            
                            results.errors.push({
                                type: 'SYNTAX_ERROR',
                                message: '–û—à–∏–±–∫–∞ —Ä–∞–∑–±–æ—Ä–∞ HTML: ' + errorText.split('\n')[0],
                                line: line,
                                column: 1
                            });
                        });
                    }
                    
                    const htmlChecks = this.checkHTMLStructure(code);
                    results.errors.push(...htmlChecks.errors);
                    results.warnings.push(...htmlChecks.warnings);
                    
                    if (results.errors.length === 0) {
                        results.executionResult = {
                            output: "HTML –∫–æ–¥ –ø—Ä–æ—à–µ–ª –ø—Ä–æ–≤–µ—Ä–∫—É —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞",
                            success: true
                        };
                    }
                } catch (error) {
                    results.errors.push({
                        type: 'ANALYSIS_ERROR',
                        message: `–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ HTML: ${error.message}`,
                        line: 1,
                        column: 1
                    });
                }
            }

            checkHTMLStructure(code) {
                const errors = [];
                const warnings = [];
                
                if (!code.includes('<!DOCTYPE')) {
                    warnings.push({
                        type: 'MISSING_DOCTYPE',
                        message: '–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å DOCTYPE',
                        line: 1,
                        column: 1
                    });
                }
                
                if (!code.includes('<html')) {
                    warnings.push({
                        type: 'MISSING_HTML',
                        message: '–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Ç–µ–≥ <html>',
                        line: 1,
                        column: 1
                    });
                }
                
                if (!code.includes('<head')) {
                    warnings.push({
                        type: 'MISSING_HEAD',
                        message: '–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Ç–µ–≥ <head>',
                        line: 1,
                        column: 1
                    });
                }
                
                if (!code.includes('<body')) {
                    warnings.push({
                        type: 'MISSING_BODY',
                        message: '–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Ç–µ–≥ <body>',
                        line: 1,
                        column: 1
                    });
                }
                
                if (!code.includes('<title>')) {
                    warnings.push({
                        type: 'MISSING_TITLE',
                        message: '–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å —Ç–µ–≥ <title>',
                        line: 1,
                        column: 1
                    });
                }
                
                return { errors, warnings };
            }

            getLineNumber(code, index) {
                return code.substring(0, index).split('\n').length;
            }

            getColumnNumber(code, index) {
                const textBefore = code.substring(0, index);
                const lastNewline = textBefore.lastIndexOf('\n');
                return lastNewline === -1 ? index + 1 : index - lastNewline;
            }

            extractLineFromError(error, code) {
                const lineMatch = error.stack?.match(/<anonymous>:(\d+):(\d+)/) || 
                                error.message?.match(/line (\d+)/i);
                return lineMatch ? parseInt(lineMatch[1]) : 1;
            }

            calculateScore(results) {
                let score = 100;
                score -= results.errors.length * 15;
                score -= results.warnings.length * 5;
                return Math.max(0, score);
            }

            displayAnalysisResults(results, code) {
                this.clearErrorMarkers();
                
                document.getElementById('error-count').textContent = `${results.errors.length} –æ—à–∏–±–æ–∫`;
                document.getElementById('warning-count').textContent = `${results.warnings.length} –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π`;
                document.getElementById('suggestion-count').textContent = `${results.suggestions.length} –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π`;

                const errorList = document.getElementById('error-list');
                errorList.innerHTML = '';

                if (results.executionResult) {
                    this.displayExecutionResult(results.executionResult, errorList);
                }

                results.errors.forEach(error => {
                    this.addIssueToPanel(error, 'error', errorList);
                    this.markErrorInEditor(error, code);
                });

                results.warnings.forEach(warning => {
                    this.addIssueToPanel(warning, 'warning', errorList);
                    this.markErrorInEditor(warning, code);
                });

                results.suggestions.forEach(suggestion => {
                    this.addIssueToPanel(suggestion, 'suggestion', errorList);
                });

                this.displayScore(results, errorList);
            }

            displayExecutionResult(result, errorList) {
                const resultDiv = document.createElement('div');
                resultDiv.className = 'execution-result';
                
                let content = '';
                if (result.success) {
                    content = `
                        <h4>‚úÖ –ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ</h4>
                        ${result.output ? `
                        <div class="output-console">–í—ã–≤–æ–¥:\n${result.output}</div>
                        ` : '<div class="output-console">–ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω –±–µ–∑ –≤—ã–≤–æ–¥–∞</div>'}
                        ${result.returnValue !== undefined ? `
                        <div style="margin-top: 0.5rem; color: var(--success-emerald)">
                            –í–æ–∑–≤—Ä–∞—â–∞–µ–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: ${JSON.stringify(result.returnValue)}
                        </div>
                        ` : ''}
                    `;
                } else {
                    content = `
                        <h4>‚ùå –û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</h4>
                        <div class="output-console" style="color: var(--error-crimson)">
                            ${result.error}
                        </div>
                    `;
                }
                
                resultDiv.innerHTML = content;
                errorList.appendChild(resultDiv);
            }

            addIssueToPanel(issue, type, errorList) {
                const item = document.createElement('div');
                item.className = `error-item ${type}`;

                const icons = {
                    'error': '‚ùå',
                    'warning': '‚ö†Ô∏è',
                    'suggestion': 'üí°'
                };

                item.innerHTML = `
                    <div class="error-header">
                        <span class="error-icon">${icons[type]}</span>
                        <span class="error-title">${issue.message}</span>
                    </div>
                    <div class="error-location">–°—Ç—Ä–æ–∫–∞ ${issue.line}, —Å—Ç–æ–ª–±–µ—Ü ${issue.column}</div>
                `;

                if (issue.line) {
                    item.addEventListener('click', () => {
                        this.editor.setCursor({ 
                            line: Math.max(0, issue.line - 1), 
                            ch: Math.max(0, issue.column - 1) 
                        });
                        this.editor.focus();
                    });
                }

                errorList.appendChild(item);
            }

            markErrorInEditor(issue, code) {
                if (!issue.line || !this.editor) return;
                
                try {
                    const lineIndex = Math.max(0, issue.line - 1);
                    
                    const from = { 
                        line: lineIndex, 
                        ch: Math.max(0, (issue.column || 1) - 1) 
                    };
                    const to = { 
                        line: lineIndex, 
                        ch: Math.max(1, (issue.column || 1)) 
                    };
                    
                    const markerClass = issue.type.includes('ERROR') ? 'error-marker' : 
                                      issue.type.includes('WARNING') ? 'warning-marker' : 'suggestion-marker';
                    
                    const marker = this.editor.markText(from, to, {
                        className: markerClass,
                        title: issue.message
                    });
                    
                    this.errorMarkers.push(marker);
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∏:', error);
                }
            }

            displayScore(results, errorList) {
                if (!this.editor.getValue().trim()) return;

                const scoreItem = document.createElement('div');
                scoreItem.className = 'error-item';
                scoreItem.style.borderLeftColor = results.score >= 80 ? 'var(--success-emerald)' : 
                                               results.score >= 60 ? 'var(--warning-amber)' : 'var(--error-crimson)';
                
                let message = '';
                if (results.errors.length === 0 && results.warnings.length === 0) {
                    message = '–û—Ç–ª–∏—á–Ω–æ! –ö–æ–¥ –±–µ–∑ –æ—à–∏–±–æ–∫ –∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π';
                } else if (results.score >= 80) {
                    message = '–•–æ—Ä–æ—à–æ! –ù–µ–±–æ–ª—å—à–∏–µ –∑–∞–º–µ—á–∞–Ω–∏—è';
                } else if (results.score >= 60) {
                    message = '–ï—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã, —Ç—Ä–µ–±—É—é—â–∏–µ –≤–Ω–∏–º–∞–Ω–∏—è';
                } else {
                    message = '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏! –¢—Ä–µ–±—É–µ—Ç—Å—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ';
                }
                
                scoreItem.innerHTML = `
                    <div class="error-header">
                        <span class="error-icon">${results.score >= 60 ? 'üìä' : 'üö®'}</span>
                        <span class="error-title">–û—Ü–µ–Ω–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞: ${results.score}/100</span>
                    </div>
                    <div class="error-description">${message}</div>
                `;
                
                errorList.appendChild(scoreItem);
            }

            displayError(message) {
                const errorList = document.getElementById('error-list');
                errorList.innerHTML = '';
                
                const errorItem = document.createElement('div');
                errorItem.className = 'error-item';
                errorItem.innerHTML = `
                    <div class="error-header">
                        <span class="error-icon">üö®</span>
                        <span class="error-title">${message}</span>
                    </div>
                `;
                
                errorList.appendChild(errorItem);
            }

            clearErrorMarkers() {
                if (this.errorMarkers && this.editor) {
                    this.errorMarkers.forEach(marker => {
                        try {
                            marker.clear();
                        } catch (error) {
                            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –º–∞—Ä–∫–µ—Ä–∞:', error);
                        }
                    });
                    this.errorMarkers = [];
                }
            }

            resetErrorPanel() {
                document.getElementById('error-list').innerHTML = '';
                document.getElementById('error-count').textContent = '0 –æ—à–∏–±–æ–∫';
                document.getElementById('warning-count').textContent = '0 –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π';
                document.getElementById('suggestion-count').textContent = '0 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const analyzer = new RealCodeAnalyzer();
            analyzer.initializeApp();
        });
    </script>
</body>
</html>
